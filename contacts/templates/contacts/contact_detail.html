{% extends "contacts/base_contacts.html" %}

{% block content %}
<h2>{{ contact.first_name }} {{ contact.last_name }}</h2>
<hr>

<dl class="row">
  <dt class="col-sm-3">Job Title</dt>
  <dd class="col-sm-9">{{ contact.job_title }}</dd>

  <dt class="col-sm-3">Phone Number</dt>
  <dd class="col-sm-9">{{ contact.phone_number }}</dd>

  <dt class="col-sm-3">Email</dt>
  <dd class="col-sm-9">{{ contact.email }}</dd>

  <dt class="col-sm-3">Organization</dt>
  <dd class="col-sm-9">{{ contact.organization }}</dd>

  <dt class="col-sm-3">Note</dt>
  <dd class="col-sm-9">{{ contact.note|linebreaks }}</dd>

  <dt class="col-sm-3">Owner</dt>
  <dd class="col-sm-9">{{ contact.owner }}</dd>
</dl>

<div class="mt-4 d-flex flex-wrap gap-2">
  <a href="{% url 'contacts:update' contact.pk %}" class="btn btn-primary">Edit</a>
  <a href="{% url 'contacts:delete' contact.pk %}" class="btn btn-danger">Delete</a>
  <a href="{% url 'contacts:list' %}" class="btn btn-secondary">Back to list</a>
</div>

<hr class="my-4">

<div class="row g-4">
  <!-- Membership table -->
  <div class="col-lg-6">
    <h5 class="mb-3">Lists this contact belongs to</h5>

    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle" id="member-lists-table">
        <thead class="table-light">
          <tr>
            <th style="width:70%">List</th>
            <th class="text-end" style="width:30%">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for l in member_lists %}
            <tr data-list-id="{{ l.id }}">
              <td>{{ l.name }}</td>
              <td class="text-end">
                <button type="button"
                        class="btn btn-sm btn-outline-danger js-remove-list"
                        data-list-id="{{ l.id }}">
                  Remove
                </button>
              </td>
            </tr>
          {% empty %}
            <tr class="text-muted">
              <td colspan="2">Not in any lists yet.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Search + add -->
  <div class="col-lg-6">
    <h5 class="mb-3">Add to a list</h5>

    <div class="mb-2 position-relative">
      <input
        type="text"
        class="form-control"
        id="list-search"
        placeholder="Type to search active listsâ€¦"
        autocomplete="off"
      />
      <div id="list-suggestions"
           class="list-group position-absolute w-100"
           style="z-index: 1000; display:none;"></div>
    </div>

    <div class="form-text">
      Start typing a list name and click one to add this contact.
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const urls = {
    search: "{% url 'contacts:list_search' %}",
    add: "{% url 'contacts:contact_list_add' contact.id %}",
    remove: "{% url 'contacts:contact_list_remove' contact.id %}",
  };
  const contactId = {{ contact.id }};

  // CSRF helper
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const csrftoken = getCookie('csrftoken');

  const input = document.getElementById('list-search');
  const dropdown = document.getElementById('list-suggestions');
  const tableBody = document.querySelector('#member-lists-table tbody');

  let lastQuery = "";
  let debounceTimer = null;

  function hideDropdown() { dropdown.style.display = 'none'; dropdown.innerHTML = ''; }
  function showSuggestions(items) {
    if (!items.length) { hideDropdown(); return; }
    dropdown.innerHTML = '';
    items.forEach(item => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'list-group-item list-group-item-action';
      btn.textContent = item.name;
      btn.dataset.listId = item.id;
      btn.addEventListener('click', () => addToList(item.id, item.name));
      dropdown.appendChild(btn);
    });
    dropdown.style.display = 'block';
  }

  function queryLists(q) {
    const url = `${urls.search}?q=${encodeURIComponent(q)}&exclude_for=${contactId}`;
    fetch(url, { credentials: 'same-origin' })
      .then(r => r.json())
      .then(data => showSuggestions(data.results || []))
      .catch(() => hideDropdown());
  }

  input.addEventListener('input', function() {
    const q = this.value.trim();
    if (q === lastQuery) return;
    lastQuery = q;

    clearTimeout(debounceTimer);
    if (q.length < 2) { hideDropdown(); return; }
    debounceTimer = setTimeout(() => queryLists(q), 180);
  });

  document.addEventListener('click', function(e) {
    if (!dropdown.contains(e.target) && e.target !== input) hideDropdown();
  });

  function addToList(listId, listName) {
    hideDropdown();
    input.value = '';

    if (tableBody.querySelector(`tr[data-list-id="${listId}"]`)) return;

    const formData = new FormData();
    formData.append('list_id', listId);

    fetch(urls.add, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) return;

      const emptyRow = tableBody.querySelector('tr.text-muted');
      if (emptyRow) emptyRow.remove();

      const tr = document.createElement('tr');
      tr.dataset.listId = String(listId);
      tr.innerHTML = `
        <td>${listName}</td>
        <td class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger js-remove-list" data-list-id="${listId}">
            Remove
          </button>
        </td>`;
      tableBody.appendChild(tr);
    });
  }

  tableBody.addEventListener('click', function(e) {
    const btn = e.target.closest('.js-remove-list');
    if (!btn) return;

    const listId = btn.dataset.listId;
    const formData = new FormData();
    formData.append('list_id', listId);

    fetch(urls.remove, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) return;

      const row = tableBody.querySelector(`tr[data-list-id="${listId}"]`);
      if (row) row.remove();

      if (!tableBody.querySelector('tr')) {
        const tr = document.createElement('tr');
        tr.className = 'text-muted';
        tr.innerHTML = `<td colspan="2">Not in any lists yet.</td>`;
        tableBody.appendChild(tr);
      }
    });
  });
})();
</script>
{% endblock %}
