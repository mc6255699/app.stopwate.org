{% extends "contacts/base_contacts.html" %}
{% load static %}

{% block extra_head %}
  <style>
    .table-rounded { border-radius: 1rem; overflow: hidden; }
    .card, .form-control, .form-select { border-radius: .75rem; }
    /* Hide Bootstrap Table’s built-in toolbar search; we use our own filter box */
    .fixed-table-toolbar .search { display: none !important; }
  </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-3">Contact Lists</h1>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div></div>
    <a href="{% url 'contacts:contactlist_create' %}" class="btn btn-primary">
      <i class="fa fa-plus me-1"></i> New List
    </a>
  </div>

  <div class="card mb-3 shadow-sm border-0" style="border-radius: 1rem;">
    <div class="card-body">
      <form method="get" novalidate class="row g-3 align-items-end">
        <div class="col-12 col-md-6">
          <input type="text" name="q" value="{{ q }}" class="form-control"
                 placeholder="Search by name, description, or owner…">
        </div>
        <div class="col-12 col-md-6">
          <select name="active" class="form-select">
            <option value="">All statuses</option>
            <option value="true"  {% if active == "true" %}selected{% endif %}>Active</option>
            <option value="false" {% if active == "false" %}selected{% endif %}>Inactive</option>
          </select>
        </div>
        {# No buttons needed; you can submit or make it JS-live below #}
      </form>
    </div>
  </div>

  {% if lists %}
    <div class="card shadow-sm border-0" style="border-radius: 1rem;">
      <div class="table-responsive table-rounded" style="border-radius: 1rem; overflow: hidden;">
        <table
          id="contactlists-table"
          class="table table-striped table-hover align-middle mb-0"
          data-toggle="table"
          data-pagination="true"
          data-page-size="50"
          data-page-list='[25, 50, 100, "All"]'
          data-search="true"            {# keep true so resetSearch works #}
          data-sortable="true"
          data-maintain-meta-data="true"
        >
          <thead class="table-success">
            <tr>
              <th data-field="name"    data-sortable="true">Name</th>
              <th data-field="desc"    data-sortable="true">Description</th>
              <th data-field="owner"   data-sortable="true">Owner</th>
              <th data-field="members" data-sortable="true" class="text-end">Members</th>
              <th data-field="status"  data-sortable="true">Status</th>
              <th data-field="actions" data-searchable="false" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in lists %}
              <tr>
                <td data-name="name">{{ item.name }}</td>
                <td data-name="desc" class="text-muted">{{ item.description|default:"—" }}</td>
                <td data-name="owner">
                  {% if item.owner %}
                    {{ item.owner.get_full_name|default:item.owner.username }}
                  {% else %}—{% endif %}
                </td>
                <td data-name="members" class="text-end">
                  <span class="badge bg-secondary">{{ item.member_count }}</span>
                </td>
                <td data-name="status">
                  {% if item.active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                  {% endif %}
                </td>
                <td data-name="actions" class="text-end">
                  <a href="{% url 'contacts:contactlist_update' item.pk %}" class="me-2" title="Edit">
                    <img src="{% static 'edit.png' %}" alt="Edit" style="width:20px;height:20px;vertical-align:middle;">
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <p>No contact lists found. <a href="{% url 'contacts:contactlist_create' %}">Create one</a>.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Make the wrapper rounded (same as contacts table page)
    const wrapper = document.querySelector('#contactlists-table')?.closest('.table-responsive');
    if (wrapper) wrapper.classList.add('table-rounded');

    const $table = $('#contactlists-table');
    const form   = document.querySelector('form[method="get"]');

    // Debounce
    const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    if (form) {
      const qField      = form.querySelector('[name="q"]');
      const activeField = form.querySelector('[name="active"]');

      // Drive Bootstrap Table's search from the "q" field
      const applyQSearch = debounce(() => {
        const term = (qField?.value || '').trim();
        $table.bootstrapTable('resetSearch', term);
      });

      // Filter by status by matching visible text ("Active"/"Inactive")
      const applyStatusFilter = () => {
        if (!activeField || !activeField.value) {
          $table.bootstrapTable('filterBy', {}); // clear
        } else {
          const wanted = activeField.value === 'true' ? 'Active' : 'Inactive';
          $table.bootstrapTable('filterBy', { status: wanted });
        }
      };

      if (qField) {
        qField.addEventListener('input', applyQSearch);
        if (qField.value) applyQSearch(); // apply on load if present
      }
      if (activeField) {
        activeField.addEventListener('change', applyStatusFilter);
        if (activeField.value) applyStatusFilter(); // apply on load if present
      }
    }
  });
</script>
{% endblock %}
