{% extends "contacts/base_contacts.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_head %}
  <style>
    .table-rounded { border-radius: 1rem; overflow: hidden; }
    .card, .form-control, .form-select { border-radius: .75rem; }
    /* Hide Bootstrap Tableâ€™s built-in toolbar search; we use our own Name field */
    .fixed-table-toolbar .search { display: none !important; }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="fw-bold">Contacts</h1>
      <p class="text-muted mb-0">Manage your network of professional contacts</p>
    </div>
    <a href="{% url 'contacts:add' %}" class="btn btn-primary d-flex align-items-center">
      <i class="fas fa-plus-circle me-2"></i> Add Contact
    </a>
  </div>

  <!-- Search & Filter Card -->
  {% if filter_form %}
  <div class="card mb-4">
    <div class="card-body p-4">
      <form method="get" id="filter-form" novalidate>
        <div class="row g-3">
          <div class="col-12 col-md-5">
            <div class="input-group">
              <span class="input-group-text bg-white border-end-0">
                <i class="fas fa-search text-muted"></i>
              </span>
              {{ filter_form.name|as_crispy_field }}
            </div>
          </div>
          <div class="col-12 col-md-5">
            <div class="input-group">
              <span class="input-group-text bg-white border-end-0">
                <i class="fas fa-building text-muted"></i>
              </span>
              {{ filter_form.organization|as_crispy_field }}
            </div>
          </div>
          <div class="col-12 col-md-2">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Contact Cards Grid -->
  <div class="row" id="contacts-container">
    {% if contacts %}
      {% for contact in contacts %}
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100 contact-card">
            <div class="card-body p-4">
              <div class="d-flex mb-3">
                <div class="avatar me-3">
                  {{ contact.first_name|first }}{{ contact.last_name|first }}
                </div>
                <div>
                  <a href="{% url 'contacts:detail' contact.pk %}" class="contact-name text-decoration-none">
                    {{ contact.first_name }} {{ contact.last_name }}
                  </a>
                  {% if contact.job_title %}
                    <p class="text-muted mb-0 small">{{ contact.job_title }}</p>
                  {% endif %}
                </div>
              </div>

              <div class="mb-3">
                {% if contact.organization %}
                  <span class="badge badge-org py-2 px-3 rounded-pill">
                    <i class="fas fa-building me-1"></i> {{ contact.organization.name|default:contact.organization }}
                  </span>
                {% endif %}
              </div>

              <div class="mb-1">
                {% if contact.email %}
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-envelope text-muted me-2"></i>
                    <a href="mailto:{{ contact.email }}" class="text-decoration-none text-body">{{ contact.email }}</a>
                  </div>
                {% endif %}

                {% if contact.phone_number %}
                  <div class="d-flex align-items-center">
                    <i class="fas fa-phone text-muted me-2"></i>
                    <a href="tel:{{ contact.phone_number }}" class="text-decoration-none text-body">{{ contact.phone_number }}</a>
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="card-footer bg-white border-top-0 d-flex justify-content-end p-3">
              <a href="{% url 'contacts:update' contact.pk %}" class="btn btn-sm btn-outline-secondary me-2">
                <i class="fas fa-edit"></i> Edit
              </a>
              <a href="{% url 'contacts:delete' contact.pk %}" class="btn btn-sm btn-outline-danger">
                <i class="fas fa-trash"></i>
              </a>
            </div>
          </div>
        </div>
      {% endfor %}

      <!-- Pagination -->
      <div class="mt-4">
        <nav aria-label="Contact pagination">
          <ul class="pagination justify-content-center" id="contact-pagination"></ul>
        </nav>
      </div>

    {% else %}
      <div class="col-12">
        <div class="card p-5 text-center">
          <div class="mb-4">
            <i class="fas fa-address-book fa-4x text-muted"></i>
          </div>
          <h3>No contacts found</h3>
          <p class="text-muted">Start building your network by adding your first contact.</p>
          <div class="mt-3">
            <a href="{% url 'contacts:add' %}" class="btn btn-primary">
              <i class="fas fa-plus-circle me-2"></i> Add New Contact
            </a>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Constants and variables
    const contactsPerPage = 9;
    const contactsContainer = document.getElementById('contacts-container');
    const contactCards = document.querySelectorAll('.col-md-6.col-lg-4');
    const paginationContainer = document.getElementById('contact-pagination');
    const searchInput = document.querySelector('input[name="name"]');
    const organizationSelect = document.querySelector('select[name="organization"]');
    const filterForm = document.getElementById('filter-form');

    // Initialize pagination
    let currentPage = 1;
    const totalPages = Math.ceil(contactCards.length / contactsPerPage);

    // Function to display contacts for the current page
    function displayContacts() {
      const startIndex = (currentPage - 1) * contactsPerPage;
      const endIndex = startIndex + contactsPerPage;

      contactCards.forEach((card, index) => {
        if (index >= startIndex && index < endIndex) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });

      renderPagination();
    }

    // Function to render pagination controls
    function renderPagination() {
      if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
      }

      let paginationHTML = '';

      // Previous button
      paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      `;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
          <li class="page-item ${currentPage === i ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }

      // Next button
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      `;

      paginationContainer.innerHTML = paginationHTML;

      // Add event listeners to pagination links
      document.querySelectorAll('.page-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = parseInt(this.getAttribute('data-page'));
          if (page >= 1 && page <= totalPages) {
            currentPage = page;
            displayContacts();
            // Scroll to top of contacts section
            contactsContainer.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });
    }

    // Debounce function for search input
    function debounce(func, delay) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }

    // Filter contacts based on search and organization
    function filterContacts() {
      const searchTerm = searchInput?.value.toLowerCase() || '';
      const selectedOrg = organizationSelect?.value || '';

      // Reset pagination to first page when filtering
      currentPage = 1;

      // Submit the form to let Django handle the filtering
      if (filterForm) {
        filterForm.submit();
      }
    }

    // Event listeners for filtering
    if (searchInput) {
      searchInput.addEventListener('input', debounce(filterContacts, 500));
    }

    if (organizationSelect) {
      organizationSelect.addEventListener('change', filterContacts);
    }

    // Initialize the contact display
    displayContacts();
  });
</script>
{% endblock %}
