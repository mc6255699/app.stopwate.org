{% extends "contacts/base_contacts.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_head %}
  <style>
    .table-rounded { border-radius: 1rem; overflow: hidden; }
    .card, .form-control, .form-select { border-radius: .75rem; }
    .remove-btn { margin-left: 1rem; color: #b00; cursor: pointer; }
  </style>
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <h1>Edit Contact List: {{ object.name }}</h1>
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" id="contactlist-form" class="mb-4">
      {% csrf_token %}
      {{ form|crispy }}
      <button type="submit" class="btn btn-success">Save Changes</button>
      <a href="{% url 'contacts:contactlist_list' %}" class="btn btn-secondary">Back</a>
    </form>

    <hr>

    <div class="row">
      <div class="col-md-6">
        <h3>Contacts in this List</h3>
        <ul id="contacts-list" class="list-group mb-2">
          {% for c in object.contacts.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ c.get_full_name|default:c.email }}
              <button class="btn btn-sm btn-outline-danger remove-contact-btn"
                      data-contact="{{ c.id }}">
                &times;
              </button>
            </li>
          {% empty %}
            <li class="list-group-item text-muted">No contacts in this list.</li>
          {% endfor %}
        </ul>

        <form id="add-contact-form" class="d-flex mb-3" autocomplete="off">
          <select class="form-select me-2" name="contact_id" required>
            <option value="">Add contact...</option>
            {% for c in contacts %}
              {% if c not in object.contacts.all %}
                <option value="{{ c.id }}">{{ c.get_full_name|default:c.email }}</option>
              {% endif %}
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-primary">Add</button>
        </form>
      </div>

      <div class="col-md-6">
        <h3>Sublists</h3>
        <ul id="sublists-list" class="list-group mb-2">
          {% for l in object.sublists.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ l.name }}
              <button class="btn btn-sm btn-outline-danger remove-sublist-btn"
                      data-sublist="{{ l.id }}">
                &times;
              </button>
            </li>
          {% empty %}
            <li class="list-group-item text-muted">No sublists in this list.</li>
          {% endfor %}
        </ul>

        <form id="add-sublist-form" class="d-flex mb-3" autocomplete="off">
          <select class="form-select me-2" name="sublist_id" required>
            <option value="">Add sublist...</option>
            {% for l in available_sublists %}
              {% if l not in object.sublists.all and l.id != object.id %}
                <option value="{{ l.id }}">{{ l.name }}</option>
              {% endif %}
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-primary">Add</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  // CSRF utility for AJAX
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0; i < cookies.length; i++) {
        const c = cookies[i].trim();
        if (c.substring(0, name.length+1) === (name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length+1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
  const listId = {{ object.id }};

  // Add contact
  document.getElementById('add-contact-form').onsubmit = function(e) {
    e.preventDefault();
    const select = this.querySelector('select[name="contact_id"]');
    const contactId = select.value;
    if (!contactId) return;

    fetch("{% url 'contacts:contact_list_add' 0 %}".replace('/0/', '/' + contactId + '/'), {
      method: "POST",
      headers: { 'X-CSRFToken': csrftoken },
      body: new URLSearchParams({ list_id: listId })
    }).then(resp => resp.json()).then(data => {
      if(data.ok) location.reload();
    });
  };

  // Remove contact
  document.querySelectorAll('.remove-contact-btn').forEach(btn => {
    btn.onclick = function() {
      const contactId = this.getAttribute('data-contact');
      fetch("{% url 'contacts:contact_list_remove' 0 %}".replace('/0/', '/' + contactId + '/'), {
        method: "POST",
        headers: { 'X-CSRFToken': csrftoken },
        body: new URLSearchParams({ list_id: listId })
      }).then(resp => resp.json()).then(data => {
        if(data.ok) location.reload();
      });
    };
  });

  // Add sublist
  document.getElementById('add-sublist-form').onsubmit = function(e) {
    e.preventDefault();
    const select = this.querySelector('select[name="sublist_id"]');
    const sublistId = select.value;
    if (!sublistId) return;

    fetch("{% url 'contacts:add_sublist_to_list' object.id %}", {
      method: "POST",
      headers: { 'X-CSRFToken': csrftoken },
      body: new URLSearchParams({ sublist_id: sublistId })
    }).then(resp => resp.json()).then(data => {
      if(data.ok) location.reload();
    });
  };

  // Remove sublist
  document.querySelectorAll('.remove-sublist-btn').forEach(btn => {
    btn.onclick = function() {
      const sublistId = this.getAttribute('data-sublist');
      fetch("{% url 'contacts:remove_sublist_from_list' object.id %}", {
        method: "POST",
        headers: { 'X-CSRFToken': csrftoken },
        body: new URLSearchParams({ sublist_id: sublistId })
      }).then(resp => resp.json()).then(data => {
        if(data.ok) location.reload();
      });
    };
  });
</script>
{% endblock %}