{% extends "contacts/base_contacts.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_head %}
<style>
  .card-rounded { border-radius: 1rem; }
  .table-rounded { border-radius: 1rem; overflow: hidden; }
  /* Add spacing below sections */
  .mb-4 { margin-bottom: 1.5rem !important; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Page header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
      {% if page_type == "create" %}New Contact
      {% elif page_type == "edit" %}Edit Contact
      {% else %}Contact Details  {% endif %}
      : {{ object.get_full_name|default:object.email }}
    </h2>
    <a href="{% url 'contacts:list' %}" class="btn btn-outline-secondary">Back to Contacts</a>
  </div>

  <!-- Form card -->
  {% if page_type != "detail" %}
  <div class="card shadow-sm mb-4 card-rounded">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}
          {% crispy form %}




  <!-- list memberships -->
  <div class="card shadow-sm mb-4 card-rounded">
    <div class="card-body p-0">
      <h4 class="mb-0 px-3 pt-3 d-flex justify-content-between align-items-center">
        List Membership
        <button id="toggle-lists" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-users"></i>
        </button>
      </h4>
      <div id="membership-section" class="table-responsive table-rounded p-3">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-success">
            <tr>
              <th>Name</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for contact_list in object.contact_lists.all %}
            <tr>
              <td>{{ contact_list.name }}</td>
              <td class="text-end">
                <form method="post" action="{% url 'contacts:contact_list_remove' object.id %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="list_id" value="{{ contact_list.id }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="2" class="text-center text-muted">Not a member of any list.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>



        <!-- Save button at bottom right -->
        <div class="d-flex justify-content-end mt-3">
          <button type="submit" class="btn btn-sm btn-outline-success" title="Save">
            <i class="fas fa-pen-to-square"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Add to Contact Lists -->
  <div class="card shadow-sm mb-4 card-rounded">
    <div class="card-body">
      <h4 class="mb-3">Add to Contact List</h4>
      <input type="text" id="list-search" class="form-control" placeholder="Type a contact list name...">
      <div id="search-results" class="list-group mt-2"></div>
    </div>
  </div>

  <!-- List Membership -->

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Toggle list membership visibility
    const toggleBtn = document.getElementById("toggle-lists");
    const membershipSection = document.getElementById("membership-section");
    toggleBtn.addEventListener("click", () => {
        membershipSection.classList.toggle("d-none");
    });

    // AJAX contact list search
    const searchInput = document.getElementById("list-search");
    const resultsDiv = document.getElementById("search-results");
    const contactId = "{{ object.id }}";
    const csrfToken = "{{ csrf_token }}";
    let timeout = null;

    searchInput.addEventListener("keyup", function() {
        clearTimeout(timeout);
        const query = this.value.trim();
        if (!query) { resultsDiv.innerHTML = ""; return; }

        timeout = setTimeout(() => {
            fetch("{% url 'contacts:list_search' %}?q=" + encodeURIComponent(query))
            .then(res => res.json())
            .then(data => {
                resultsDiv.innerHTML = "";
                const alreadyMemberIds = [{% for contact_list in object.contact_lists.all %}{{ contact_list.id }},{% endfor %}];
                (data.results || []).forEach(list => {
                    if (alreadyMemberIds.includes(list.id)) return;
                    const item = document.createElement("div");
                    item.className = "list-group-item d-flex justify-content-between align-items-center";
                    item.innerHTML = `
                        <span>${list.name}</span>
                        <form method="post" action="/contacts/${contactId}/lists/add/" style="display: inline;">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                            <input type="hidden" name="list_id" value="${list.id}">
                            <button type="submit" class="btn btn-sm btn-success ms-3">Add</button>
                        </form>
                    `;
                    resultsDiv.appendChild(item);
                });
                if (!resultsDiv.innerHTML.trim()) {
                    resultsDiv.innerHTML = "<div class='list-group-item text-muted'>No lists found.</div>";
                }
            });
        }, 300);
    });
});
</script>
{% endblock %}
